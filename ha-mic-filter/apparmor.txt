#include <tunables/global>

profile ha-mic-filter flags=(attach_disconnected,mediate_deleted) {
  #include <abstractions/base>

  # File permissions cơ bản
  file,
  signal (send) set=(kill,term,int,hup,cont),

  # S6-Overlay cho Home Assistant addon
  /init ix,
  /bin/** ix,
  /usr/bin/** ix,
  /sbin/** ix,
  /run/{s6,s6-rc*,service}/** ix,
  /package/** ix,
  /command/** ix,
  /etc/services.d/** rwix,
  /etc/cont-init.d/** rwix,
  /etc/cont-finish.d/** rwix,
  /run/{,**} rwk,
  /dev/tty rw,

  # Bashio cho Home Assistant integration
  /usr/lib/bashio/** ix,

  # CRITICAL: Audio device access cho real-time audio
  # Chỉ cần rw /dev/snd - không cần modprobe hay sys_admin
  /dev/snd/** rw,
  /proc/asound/** r,
  /sys/devices/system/cpu/online r,
  /sys/class/sound/** r,

  # CRITICAL: PulseAudio Null Sink + Monitor Source
  # Cách duy nhất tạo virtual mic trên Home Assistant OS
  /etc/pulse/** r,
  /run/pulse/** rw,
  /tmp/pulse-*/** rw,
  /var/lib/pulse/** rw,

  # CRITICAL: pactl commands cho PulseAudio module management
  # module-null-sink + module-virtual-source
  /usr/bin/pactl ix,
  /usr/bin/pulseaudio ix,
  /usr/bin/pulse* ix,

  # Python cho audio processing (sounddevice, pulsectl, numpy)
  /usr/bin/python3 ix,
  /usr/lib/python*/** mr,
  /usr/local/lib/** mr,
  /lib/** mr,
  /lib64/** mr,
  /app/** rwix,
  /app/lib/** mr,

  # Network không cần thiết cho dự án này
  # Chỉ cần unix socket cho PulseAudio communication
  network unix stream,
  network unix dgram,

  # System files cần thiết
  /etc/ld.so.cache r,
  /etc/passwd r,
  /etc/group r,
  /etc/nsswitch.conf r,
  /etc/hosts r,
  /etc/resolv.conf r,

  # Home Assistant addon data
  /data/** rw,
  /config/** rw,
  /share/** rw,

  # Temporary files cho audio processing
  /tmp/** rwk,
  /var/tmp/** rwk,

  # Process info cho monitoring
  /proc/meminfo r,
  /proc/stat r,
  /proc/cpuinfo r,
  /proc/version r,
  /proc/sys/kernel/random/uuid r,

  # Child profile cho main service
  /usr/bin/python3 cx -> mic_filter_service,

  profile mic_filter_service flags=(attach_disconnected,mediate_deleted) {
    #include <abstractions/base>
    #include <abstractions/python>

    # Signal handling
    signal (receive) peer=*_ha-mic-filter,

    # Home Assistant data access
    /data/** rw,
    /config/** rw,
    /share/** rw,

    # Audio devices cho real-time processing
    /dev/snd/** rw,
    /proc/asound/** r,
    /sys/devices/system/cpu/online r,

    # PulseAudio cho virtual microphone
    /etc/pulse/** r,
    /run/pulse/** rw,
    /tmp/pulse-*/** rw,
    /var/lib/pulse/** rw,

    # pactl command execution
    /usr/bin/pactl ix,
    /usr/bin/pulseaudio ix,
    /usr/bin/pulse* ix,

    # Python application
    /app/** rwix,
    /usr/bin/python3 ix,
    /usr/lib/python*/** mr,
    /usr/local/lib/** mr,
    /lib/** mr,
    /lib64/** mr,
    /app/lib/** mr,

    # Network chỉ cần unix socket cho PulseAudio
    network unix stream,
    network unix dgram,

    # Essential system files
    /etc/passwd r,
    /etc/group r,
    /etc/nsswitch.conf r,
    /etc/hosts r,
    /etc/resolv.conf r,
    /etc/ld.so.cache r,
    /dev/tty rw,

    # Process monitoring
    /proc/meminfo r,
    /proc/stat r,
    /proc/cpuinfo r,
    /proc/version r,
    /proc/sys/kernel/random/uuid r,

    # Temporary files
    /tmp/** rwk,
    /var/tmp/** rwk,
  }
}
